<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Ajouter une commande Dell</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif;background:#f6f7fb;margin:0}
    header{background:#178a2e;color:#fff;padding:18px 22px;font-size:22px;font-weight:700}
    .wrap{max-width:980px;margin:22px auto;padding:0 16px}
    .card{background:#fff;border-radius:8px;box-shadow:0 1px 4px rgba(0,0,0,.08);padding:18px 18px 8px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    label{display:block;font-weight:600;margin-bottom:6px}
    input[type=text],select{width:100%;box-sizing:border-box;padding:10px;border:1px solid #d6d8df;border-radius:6px;background:#fff}
    input[disabled]{background:#f2f3f7;color:#7c7f8b}
    .actions{margin-top:16px;display:flex;gap:10px}
    .btn{padding:10px 14px;border-radius:6px;border:0;cursor:pointer;font-weight:600}
    .btn-primary{background:#178a2e;color:#fff}
    .btn-secondary{background:#e8eaf1}
    .note{font-size:12px;color:#6b7280;margin-top:4px}
    .alert{margin:14px 0;padding:12px;border-radius:6px}
    .alert-ok{background:#e8f6ee;color:#115c22;border:1px solid #bfe6cb}
    .alert-err{background:#fde8e8;color:#8b1e1e;border:1px solid #f5b5b5}
    pre{background:#0f172a;color:#e2e8f0;padding:12px;border-radius:8px;overflow:auto}
    a.back{display:inline-block;margin-top:10px;color:#178a2e;text-decoration:none}
  </style>
</head>
<body>
<header>Ajouter une commande Dell</header>
<div class="wrap">

  {% if message_ok %}
    <div class="alert alert-ok">{{ message_ok }}</div>
  {% endif %}
  {% if message_error %}
    <div class="alert alert-err">{{ message_error }}</div>
  {% endif %}

  <form method="post" action="/orders/add" class="card">
    <div class="grid">
      <div>
        <label for="po_number">PO Number</label>
        <input id="po_number" name="po_number" type="text" required>
      </div>
      <div>
        <label for="status">Statut</label>
        <select id="status" name="status">
          <option value="Pending">Pending</option>
          <option value="Approved">Approved</option>
          <option value="Rejected">Rejected</option>
        </select>
      </div>
    </div>

    <h3 style="margin-top:18px">Informations serveur / site</h3>
    <div class="grid">
      <div>
        <label for="cfi_code">CFI Code</label>
        <input id="cfi_code" name="cfi_code" type="text" value="" disabled>
        <div class="note">Donnée en dur (non modifiable).</div>
      </div>

      <div>
        <label for="site_id">Site</label>
        <select id="site_id" name="site_id" required>
          <option value="">— Sélectionner —</option>
          {% for s in sites %}
          <option value="{{ s.id }}" data-country="{{ s.country }}">{{ s.label }}</option>
          {% endfor %}
        </select>
      </div>

      <div>
        <label for="country">Country</label>
        <input id="country" name="country" type="text" value="" disabled>
        <div class="note">Auto-renseigné selon le site.</div>
      </div>

      <div>
        <label for="ap_code">AP code authorized</label>
        <select id="ap_code" name="ap_code">
          <option value="">— Sélectionner —</option>
          {% for code in ap_codes %}
          <option value="{{ code }}">{{ code }}</option>
          {% endfor %}
        </select>
      </div>
    </div>

    <h3 style="margin-top:18px">Réseau / Zone / Alimentation</h3>
    <div class="grid">
      <div>
        <label for="nic_interface_number">NIC Interface Number</label>
        <input id="nic_interface_number" name="nic_interface_number" type="text" value="" disabled>
      </div>

      <div>
        <label for="physical_zone">Physical Zone</label>
        <select id="physical_zone" name="physical_zone">
          <option value="">— Sélectionner —</option>
          {% for z in physical_zones %}
          <option value="{{ z }}">{{ z }}</option>
          {% endfor %}
        </select>
      </div>

      <div>
        <label for="power_watt">Power Watt</label>
        <select id="power_watt" name="power_watt">
          {% for w in power_watts %}
          <option value="{{ w }}">{{ w }}</option>
          {% endfor %}
        </select>
      </div>
    </div>

    <h3 style="margin-top:18px">Autres</h3>
    <div class="grid">
      <div>
        <label for="san">SAN</label>
        <input id="san" name="san" type="text" value="" disabled>
      </div>
      <div>
        <label for="heartbeat">HeartBeat</label>
        <input id="heartbeat" name="heartbeat" type="text" value="" disabled>
      </div>
      <div>
        <label for="soki_name">Soki Name</label>
        <input id="soki_name" name="soki_name" type="text" placeholder="Nom ajouté par CT">
      </div>
    </div>

    <div class="actions">
      <button class="btn btn-primary" type="submit">➕ Ajouter</button>
      <a class="btn btn-secondary" href="/">Retour à l’accueil</a>
    </div>

    {% if order_json %}
      <h3 style="margin-top:18px">Prévisualisation JSON</h3>
      <pre>{{ order_json | tojson(indent=2) }}</pre>
    {% endif %}
  </form>

  <a class="back" href="/">← Retour à l'accueil</a>
</div>

<script>
  // Auto-fill Country when Site changes – using embedded data-attr or AJAX
  const siteSelect = document.getElementById('site_id');
  const countryInput = document.getElementById('country');

  async function updateCountry() {
    const opt = siteSelect.options[siteSelect.selectedIndex];
    const fromAttr = opt ? opt.getAttribute('data-country') : '';
    if (fromAttr) { countryInput.value = fromAttr; return; }

    const id = siteSelect.value;
    if (!id) { countryInput.value = ''; return; }
    try {
      const res = await fetch(`/orders/site-info?site_id=${encodeURIComponent(id)}`);
      if (res.ok) {
        const data = await res.json();
        countryInput.value = data.country || '';
      }
    } catch(_) {}
  }
  siteSelect.addEventListener('change', updateCountry);
  updateCountry();
</script>
</body>
</html>
