<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Ajouter une commande (PO)</title>
  <link rel="stylesheet" href="/static/style.css" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{--ink:#1f2937;--muted:#6b7280;--border:#e5e7eb;--card:#fff;--bg:#f7f7f9;--brand:#14823b}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);
      font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial}
    .shell{max-width:1200px;margin:24px auto;padding:0 16px}
    .hero,.toolbar,.card{background:var(--card);border:1px solid var(--border);border-radius:10px}
    .hero{display:flex;align-items:center;gap:12px;padding:12px 14px;margin-bottom:14px}
    .hero img{height:28px}.hero h1{margin:0;font-size:18px}
    .toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;padding:12px 14px;margin-bottom:14px}
    .toolbar .spacer{flex:1}
    .btn{background:var(--brand);color:#fff;border:0;border-radius:8px;padding:8px 12px;font-weight:600;cursor:pointer}
    .btn--ghost{background:#fff;color:#111;border:1px solid var(--border)}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .input{border:1px solid var(--border);border-radius:8px;padding:6px 10px;width:100%}
    .card{overflow:hidden}
    table{width:100%;border-collapse:separate;border-spacing:0}
    thead th{position:sticky;top:0;background:#fbfbfc;border-bottom:1px solid var(--border);
      font-size:12px;text-transform:uppercase;color:var(--muted);padding:10px;text-align:left}
    td{border-bottom:1px solid var(--border);padding:10px;vertical-align:middle}
    .row-actions{white-space:nowrap}
    .alert{border:1px solid #f0c6c6;background:#fdecec;color:#8b2a2a;border-radius:8px;padding:10px 12px}
    .muted{color:var(--muted)}
  </style>
</head>
<body>
<div class="shell">

  <div class="hero">
    <img src="/static/bnp_logo.png" alt="BNP">
    <h1>Ajouter une commande (PO)</h1>
  </div>

  <!-- Accueil is ALWAYS active -->
  <div class="toolbar">
    <div class="spacer"></div>
    <a class="btn btn--ghost" href="/">Accueil</a>
    {% if not locked %}
      <button id="submitBtn" class="btn">Add PO Command</button>
    {% endif %}
  </div>

  {% if locked %}
    <div class="card" style="padding:12px 14px">
      <div class="alert">
        Un fichier <b>orders.json</b> existe dÃ©jÃ . La page est verrouillÃ©e jusquâ€™Ã  suppression via
        <code>DELETE /orders/json</code>.
      </div>
    </div>
  {% else %}
    <!-- FORM AREA (only when unlocked) -->
    <div class="card">
      <div class="toolbar" style="border:0;border-bottom:1px solid var(--border);border-radius:0;margin:0">
        <button id="addLine" class="btn btn--ghost" type="button">Ajouter une ligne</button>
      </div>

      <div style="overflow:auto; max-height:70vh">
        <table id="poTable">
          <thead>
            <tr>
              <th>PO Number</th>
              <th>Project Name</th>
              <th>Business Unit</th>
              <th>RITM Request</th>
              <th>Vendor</th>
              <th>AP Code Authorized</th>
              <th class="row-actions">â€”</th>
            </tr>
          </thead>
          <tbody id="poBody">
            <!-- rows injected by JS -->
          </tbody>
        </table>
      </div>

      <!-- Hidden field posted to server -->
      <form id="poForm" method="post" action="/orders/add" style="display:none">
        <input type="hidden" name="json_payload" id="json_payload">
      </form>
    </div>
  {% endif %}

</div>

{% if not locked %}
<script>
(function(){
  const body   = document.getElementById('poBody');
  const addBtn = document.getElementById('addLine');
  const submit = document.getElementById('submitBtn');
  const form   = document.getElementById('poForm');
  const out    = document.getElementById('json_payload');

  function newRow(){
    const tr = document.createElement('tr');

    // PO Number
    let td = document.createElement('td');
    td.innerHTML = '<input class="input" name="po_number" required>';
    tr.appendChild(td);

    // Project Name
    td = document.createElement('td');
    td.innerHTML = '<input class="input" name="project_name" required>';
    tr.appendChild(td);

    // Business Unit
    td = document.createElement('td');
    td.innerHTML = '<input class="input" name="business_unit" required>';
    tr.appendChild(td);

    // RITM Request
    td = document.createElement('td');
    td.innerHTML = '<input class="input" name="ritm_request">';
    tr.appendChild(td);

    // Vendor (only DELL)
    td = document.createElement('td');
    td.innerHTML =
      '<select class="input" name="vendor" required>' +
      '  <option value="dell" selected>Dell</option>' +
      '</select>';
    tr.appendChild(td);

    // AP code
    td = document.createElement('td');
    td.innerHTML = '<input class="input" name="ap_code_authorized">';
    tr.appendChild(td);

    // Actions
    td = document.createElement('td'); td.className='row-actions';
    td.innerHTML = '<button type="button" class="btn btn--ghost" onclick="this.closest(\'tr\').remove()">ðŸ—‘</button>';
    tr.appendChild(td);

    body.appendChild(tr);
  }

  function collect(){
    const rows = [...body.querySelectorAll('tr')];
    const orders = rows.map(tr => {
      const g = name => (tr.querySelector(`[name="${name}"]`) || {}).value || '';
      return {
        po_number: g('po_number').trim(),
        project_name: g('project_name').trim(),
        business_unit: g('business_unit').trim(),
        ritm_request: g('ritm_request').trim(),
        vendor: 'dell',              // fixed
        ap_code_authorized: g('ap_code_authorized').trim(),
        status: 'pending'            // fixed per your instruction
      };
    }).filter(o => o.po_number || o.project_name || o.business_unit);

    return { orders };
  }

  addBtn.addEventListener('click', newRow);

  submit.addEventListener('click', () => {
    const payload = collect();
    if (payload.orders.length === 0){
      alert("Ajoutez au moins une ligne.");
      return;
    }
    out.value = JSON.stringify(payload);
    form.submit();
  });

  // start with one empty row
  newRow();
})();
</script>
{% endif %}
</body>
</html>
