<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Serveurs en stock (warehouse)</title>
  <link rel="stylesheet" href="/static/style.css" />
  <style>
    .table-responsive{overflow:auto}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{border:1px solid #ddd;padding:6px;white-space:nowrap}
    .table thead th{background:#f5f5f5;position:sticky;top:0}
    .alert{margin:10px 0;padding:10px;border-radius:4px}
    .alert-success{background:#e7f6ec;border:1px solid #b8e0c7}
    .alert-danger{background:#fdeaea;border:1px solid #f1b4b4}
    .actions{display:flex;gap:10px;align-items:center;margin:10px 0}
    .btn{padding:6px 10px;border:1px solid #0c6;border-radius:4px;background:#0c6;color:#fff;cursor:pointer}
    .btn:disabled{opacity:.6;cursor:not-allowed}
  </style>
</head>
<body>
  <h2>Serveurs en stock (warehouse)</h2>

  {% if message_ok %}
    <div class="alert alert-success">{{ message_ok }}</div>
  {% endif %}
  {% if message_error %}
    <div class="alert alert-danger">{{ message_error }}</div>
  {% endif %}

  <form method="post" action="/servers/warehouse" onsubmit="return beforeSubmit()">
    <input type="hidden" name="selected_ids" id="selected_ids" value="" />
    <input type="hidden" name="data_payload" id="data_payload" value="[]" />

    <div class="actions">
      <label><input type="checkbox" id="check_all" onclick="toggleAll(this)"> Tout cocher</label>
      <button class="btn" type="submit">Générer le JSON des serveurs cochés</button>
    </div>

    <div class="table-responsive">
      <table class="table table-sm">
        <thead>
          <tr>
            <th><input type="checkbox" id="check_all2" onclick="toggleAll(this)"></th>
            <th>PO Number</th>
            <th>Vendor</th>
            <th>Model</th>
            <th>CFI Code</th>
            <th>Serial</th>
            <th>Country</th>
            <th>NIC Interface Number</th>
            <th>AP code authorized</th>
            <th>Physical Zone</th>
            <th>Power Watt</th>
            <th>HeartBeat</th>
            <th>Soki Name</th>
            <th>SAN</th>
          </tr>
        </thead>
        <tbody id="tbl">
          {% for s in servers %}
          <tr data-id="{{ s.id }}">
            <td><input type="checkbox" class="row-check"></td>
            <td>{{ s.po_number }}</td>
            <td>{{ s.vendor }}</td>
            <td>{{ s.model }}</td>
            <td>{{ s.cfi_code }}</td>
            <td>{{ s.serial }}</td>
            <td>{{ s.country }}</td>
            <td><input type="number" min="0" value="{{ s.nic_count }}" class="nic"></td>

            <td>
              <select class="apcode">
                <option value="">— Sélectionner —</option>
                {% for ap in ap_codes %}
                  <option value="{{ ap }}" {% if ap == s.ap_code_authorized %}selected{% endif %}>{{ ap }}</option>
                {% endfor %}
              </select>
            </td>

            <td>
              <select class="pzone">
                <option value="">— Sélectionner —</option>
                {% for z in physical_zones %}
                  <option value="{{ z }}">{{ z }}</option>
                {% endfor %}
              </select>
            </td>

            <td>
              <select class="pwatt">
                <option value="">—</option>
                <option>150</option><option>200</option><option>250</option><option>300</option>
                <option>350</option><option>400</option><option>450</option><option>500</option>
                <option>550</option><option>600</option><option>650</option><option>700</option>
                <option>750</option><option>800</option><option>850</option><option>900</option>
                <option>950</option>
              </select>
            </td>

            <td style="text-align:center"><input type="checkbox" class="heartbeat"></td>
            <td><input type="text" class="soki" value=""></td>
            <td style="text-align:center"><input type="checkbox" class="san"></td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </form>

<script>
function toggleAll(box){
  const checks = document.querySelectorAll('.row-check');
  checks.forEach(c => c.checked = box.checked);
}

function beforeSubmit(){
  const rows = Array.from(document.querySelectorAll('#tbl tr'));
  const selected = [];
  const payload = [];
  rows.forEach(tr => {
    const id = tr.getAttribute('data-id');
    const checked = tr.querySelector('.row-check').checked;
    const nic    = tr.querySelector('.nic').value || null;
    const ap     = tr.querySelector('.apcode').value || null;
    const pz     = tr.querySelector('.pzone').value || null;
    const pw     = tr.querySelector('.pwatt').value || null;
    const hb     = tr.querySelector('.heartbeat').checked || false;
    const soki   = tr.querySelector('.soki').value || '';
    const san    = tr.querySelector('.san').checked || false;

    const base = {
      id,
      nic_count: nic ? parseInt(nic) : 0,
      ap_code_authorized: ap || "",
      physical_zone: pz || "",
      power_watt: pw ? parseInt(pw) : null,
      heartbeat: hb,
      soki_name: soki || "",
      san: san
    };

    if (checked) selected.push(id);
    payload.push(base);
  });

  document.getElementById('selected_ids').value = selected.join(',');
  document.getElementById('data_payload').value = JSON.stringify(
    payload.filter(p => selected.includes(p.id))
  );
  return true;
}
</script>
</body>
</html>
