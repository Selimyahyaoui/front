<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Serveurs en stock (warehouse)</title>
  <link rel="stylesheet" href="/static/style.css" />
  <style>
    /* keep the “old look” but make columns readable */
    .panel      { background:#fff; border:1px solid #e0e0e0; border-radius:8px; padding:18px; }
    .toolbar    { display:flex; gap:10px; align-items:center; justify-content:flex-end; margin-bottom:12px; }
    .btn        { border:0; border-radius:6px; padding:8px 14px; cursor:pointer; }
    .btn-primary{ background:#2ecc71; color:#fff; }
    .btn-ghost  { background:#f3f5f7; color:#333; }
    .btn:disabled{ opacity:.5; cursor:not-allowed; }
    table       { width:100%; border-collapse:separate; border-spacing:0 8px; }
    thead th    { font-size:12px; letter-spacing:.02em; color:#6b7280; text-transform:uppercase; }
    tbody td    { background:#f8fafc; border:1px solid #e5e7eb; padding:6px; }
    tbody tr td:first-child { border-radius:6px 0 0 6px; }
    tbody tr td:last-child  { border-radius:0 6px 6px 0; }
    .cell       { display:flex; align-items:center; gap:8px; }
    .cell input[type="text"] { width: 140px; }             /* show full values */
    .cell input.readonly     { background:#eef2f7; }
    .cell .short             { width: 70px; }
    .cell .xs                { width: 52px; text-align:center; }
    .cell select             { min-width: 120px; }
    .row-check               { transform: translateY(2px); }
    .header-row              { display:flex; align-items:center; gap:10px; justify-content:space-between; }
    .left-actions            { display:flex; align-items:center; gap:10px; }
    .right-actions           { display:flex; align-items:center; gap:10px; }
    .muted                   { color:#6b7280; font-size:12px; }
  </style>
</head>
<body>
  <div class="panel">
    <div class="header-row">
      <div>
        <h2 style="margin:0;">Serveurs en stock (warehouse)</h2>
        <div class="muted">Sélectionnez, modifiez puis générez le JSON</div>
      </div>
      <div class="right-actions">
        <!-- master “Tout cocher” (outside table header on purpose) -->
        <label class="muted"><input id="check_all" type="checkbox" /> Tout cocher</label>
        <button id="btn-generate" class="btn btn-primary" disabled>Générer le JSON des serveurs cochés</button>
        <a href="/" class="btn btn-ghost">Accueil</a>
      </div>
    </div>

    <!-- We’ll fill this hidden field with the JSON payload on submit -->
    <form id="payloadForm" method="post" action="/servers/warehouse/json">
      <input type="hidden" name="payload" id="payload" />
    </form>

    <table>
      <thead>
        <tr>
          <!-- no checkbox in header -->
          <th></th>
          <th>PO Number</th>
          <th>Vendor</th>
          <th>Model</th>
          <th>CFI Code</th>
          <th>Serial</th>
          <th>Country</th>
          <th>NIC Interface Number</th>
          <th>AP code authorized</th>
          <th>Physical Zone</th>
          <th>Power Watt</th>
          <th>HeartBeat</th>
          <th>Soki Name</th>
          <th>SAN</th>
        </tr>
      </thead>
      <tbody>
      {% for s in servers %}
        <tr data-id="{{ s.id }}">
          <td class="cell">
            <input type="checkbox" class="row-check" />
          </td>

          <td class="cell"><input class="readonly" type="text" value="{{ s.po_number }}" readonly /></td>
          <td class="cell"><input class="readonly short" type="text" value="{{ s.vendor }}" readonly /></td>
          <td class="cell"><input class="readonly short" type="text" value="{{ s.model }}" readonly /></td>
          <td class="cell"><input class="readonly short" type="text" value="{{ s.cfi_code }}" readonly /></td>
          <td class="cell"><input class="readonly short" type="text" value="{{ s.serial }}" readonly /></td>
          <td class="cell"><input class="readonly xs" type="text" value="{{ s.country }}" readonly /></td>

          <td class="cell">
            <input type="number" class="xs nic" min="0" step="1" value="{{ s.nic_count }}" />
          </td>

          <td class="cell">
            <select class="ap">
              <option value=""></option>
              {% for ap in ap_codes %}
                <option value="{{ ap }}" {% if ap==s.ap_code %}selected{% endif %}>{{ ap }}</option>
              {% endfor %}
            </select>
          </td>

          <td class="cell">
            <select class="pz">
              <option value=""></option>
              {% for pz in physical_zones %}
                <option value="{{ pz }}" {% if pz==s.physical_zone %}selected{% endif %}>{{ pz }}</option>
              {% endfor %}
            </select>
          </td>

          <td class="cell">
            <select class="pw xs">
              <option value=""></option>
              {% for w in power_watts %}
                <option value="{{ w }}" {% if w==s.power_watt %}selected{% endif %}>{{ w }}</option>
              {% endfor %}
            </select>
          </td>

          <td class="cell"><input type="text" class="hb short" value="{{ s.heartbeat or '' }}" /></td>
          <td class="cell"><input type="text" class="soki short" value="{{ s.soki_name or '' }}" /></td>
          <td class="cell"><input type="text" class="san short" value="{{ s.san or '' }}" /></td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  </div>

  <script>
    const checkAll = document.getElementById('check_all');
    const generateBtn = document.getElementById('btn-generate');
    const form = document.getElementById('payloadForm');
    const payloadInput = document.getElementById('payload');

    function selectedRows() {
      return Array.from(document.querySelectorAll('tbody .row-check:checked'))
                  .map(cb => cb.closest('tr'));
    }

    function refreshButton() {
      generateBtn.disabled = selectedRows().length === 0;
    }

    // master checkbox
    checkAll?.addEventListener('change', () => {
      document.querySelectorAll('tbody .row-check').forEach(cb => { cb.checked = checkAll.checked; });
      refreshButton();
    });

    // per-row checkboxes
    document.querySelectorAll('tbody .row-check').forEach(cb => {
      cb.addEventListener('change', refreshButton);
    });

    // build payload then POST
    generateBtn.addEventListener('click', (e) => {
      e.preventDefault();
      const rows = selectedRows();
      if (!rows.length) return;

      const out = rows.map(tr => {
        const id = tr.getAttribute('data-id');
        return {
          id: Number(id),
          po_number:   tr.querySelector('td:nth-child(2) input').value,
          vendor:      tr.querySelector('td:nth-child(3) input').value,
          model:       tr.querySelector('td:nth-child(4) input').value,
          cfi_code:    tr.querySelector('td:nth-child(5) input').value,
          serial:      tr.querySelector('td:nth-child(6) input').value,
          country:     tr.querySelector('td:nth-child(7) input').value,
          nic_count:   Number(tr.querySelector('.nic').value || 0),
          ap_code:     tr.querySelector('.ap').value || '',
          physical_zone: tr.querySelector('.pz').value || '',
          power_watt:  tr.querySelector('.pw').value ? Number(tr.querySelector('.pw').value) : null,
          heartbeat:   tr.querySelector('.hb').value || '',
          soki_name:   tr.querySelector('.soki').value || '',
          san:         tr.querySelector('.san').value || ''
        };
      });

      payloadInput.value = JSON.stringify(out);
      form.submit();
    });

    // initial state
    refreshButton();
  </script>
</body>
</html>
