<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Importer des assets</title>
  <link rel="stylesheet" href="/static/style.css" />
</head>
<body>
  <div class="shell">
    <div class="header">
      <div class="brand">
        <img src="/static/bnp_logo.png" alt="BNP Paribas" />
        <div>
          <div class="title">Importer des assets</div>
          <div class="subtitle">Déposez un CSV. La page est verrouillée si un JSON existe déjà.</div>
        </div>
      </div>
      <a class="btn" href="/">Accueil</a>
    </div>

    <!-- Messages -->
    {% if message_ok %}
      <div class="alert success">{{ message_ok }}</div>
    {% endif %}
    {% if message_error %}
      <div class="alert error">{{ message_error }}</div>
    {% endif %}

    <!-- Upload card -->
    <div class="card">
      {% if locked %}
        <div class="err" style="margin-bottom:12px;">
          Import verrouillé : un fichier JSON est présent (<code>{{ lock_path }}</code>).
          Supprimez-le via l’API <code>DELETE /assets/json</code> pour déverrouiller.
        </div>
      {% endif %}

      <form method="post" action="/assets/upload" enctype="multipart/form-data" class="toolbar">
        <div>
          <label for="file"><strong>Fichier CSV</strong></label><br />
          <input type="file" id="file" name="file" accept=".csv" {% if locked %}disabled{% endif %} />
          <div class="hint">Le fichier sera stocké sur le PV ({{ lock_path | replace('assets_transformed.json','') }}).</div>
        </div>

        <div style="margin-left:auto; display:flex; gap:8px; align-items:center;">
          <input type="hidden" name="page" value="{{ page }}" />
          <input type="hidden" name="per_page" value="{{ per_page }}" />
          <button class="btn btn-primary" type="submit" {% if locked %}disabled{% endif %}>Importer</button>
        </div>
      </form>
    </div>

    <!-- Preview table (moved to the bottom) -->
    <div class="card">
      <div class="toolbar">
        <div class="hint">Aperçu des assets (T_AssetReport)</div>
        <div style="margin-left:auto; display:flex; align-items:center; gap:8px;">
          <form method="get" action="/assets/upload" style="display:flex; align-items:center; gap:8px;">
            <label for="per_page">Par page</label>
            <select id="per_page" name="per_page" onchange="this.form.submit()">
              <option value="10"  {% if per_page == 10  %}selected{% endif %}>10</option>
              <option value="20"  {% if per_page == 20  %}selected{% endif %}>20</option>
              <option value="50"  {% if per_page == 50  %}selected{% endif %}>50</option>
              <option value="100" {% if per_page == 100 %}selected{% endif %}>100</option>
            </select>
            <input type="hidden" name="page" value="{{ page }}" />
          </form>
        </div>
      </div>

      <div style="overflow:auto;">
        <table class="tbl">
          <thead>
            <tr>
              <th>ID</th>
              <th>Date ajout</th>
              <th>Serial</th>
              <th>CFI code</th>
              <th>Région</th>
              <th>CFI name</th>
              <th>Client #</th>
              <th>Client</th>
              <th>CPU</th>
              <th>Sockets</th>
              <th>Cœurs</th>
              <th>Modèle</th>
              <th>Adresse client</th>
              <th>Code postal</th>
              <th>Pays</th>
              <th>Order #</th>
              <th>PO</th>
              <th>BMC MAC</th>
              <th>Mémoire (MB)</th>
              <th>HBA</th>
              <th>BOSS</th>
              <th>PERC</th>
              <th>NVMe</th>
              <th>GPU</th>
            </tr>
          </thead>
          <tbody>
          {% for r in rows %}
            <tr>
              <td>{{ r[0] }}</td>
              <td>{{ r[1] }}</td>
              <td>{{ r[2] }}</td>
              <td>{{ r[3] }}</td>
              <td>{{ r[4] }}</td>
              <td>{{ r[5] }}</td>
              <td>{{ r[6] }}</td>
              <td>{{ r[7] }}</td>
              <td>{{ r[8] }}</td>
              <td>{{ r[9] }}</td>
              <td>{{ r[10] }}</td>
              <td>{{ r[11] }}</td>
              <td>{{ r[12] }}</td>
              <td>{{ r[13] }}</td>
              <td>{{ r[14] }}</td>
              <td>{{ r[15] }}</td>
              <td>{{ r[16] }}</td>
              <td>{{ r[17] }}</td>
              <td>{{ r[18] }}</td>
              <td>{{ r[19] }}</td>
              <td>{{ r[20] }}</td>
              <td>{{ r[21] }}</td>
              <td>{{ r[22] }}</td>
              <td>{{ r[23] }}</td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>

      <div class="pagination">
        {% if page > 1 %}
          <a class="btn" href="/assets/upload?page={{ page - 1 }}&per_page={{ per_page }}">Précédent</a>
        {% endif %}
        <span>Page {{ page }}</span>
        {% if (page * per_page) < total %}
          <a class="btn" href="/assets/upload?page={{ page + 1 }}&per_page={{ per_page }}">Suivant</a>
        {% endif %}
        <span style="margin-left:auto;">Total : {{ total }}</span>
      </div>
    </div>

  </div>
</body>
</html>
